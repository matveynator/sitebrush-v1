<?php
//the group is system;
$s                        = dirname($_SESSION['REQUEST_URI']);
$_SESSION['LoggedIn']     = TRUE;
$_SESSION['UserId']       = '13';
$_SESSION['AutoGrab']     = '1';
$_SESSION['DomainToGrab'] = '217.13.215.203';
$pre                      = '

<style type="text/css">
body {
margin-left: 0px;
margin-top: 0px;
margin-right: 0px;
margin-bottom: 0px;
background-color: #ffffff;
color: #333333;
font-size:16px;
font-family:Arial, Helvetica;
}</style>
<script language="JavaScript">
<!--
function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}
function MM_openBrWindow(theURL,winName,features) { //v2.0
  window.open(theURL,winName,features);
}
function MM_swapImgRestore() { //v3.0
  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
}
function MM_findObj(n, d) { //v4.01
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && d.getElementById) x=d.getElementById(n); return x;
}
function MM_swapImage() { //v3.0
  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
}
//-->
</script>
<table border="0" cellpadding="0" cellspacing="0" style="height: 600px; width: 100%; ">
	<tbody>
		<tr>
			<td style="text-align: left; vertical-align: top; width: 200px; height: 400px; ">
				<table border="0" cellpadding="0" cellspacing="0" height="600" width="100%">
					<tbody>
						<tr align="center" valign="TOP">
							<td style="text-align: left; vertical-align: top; width: 200px; height: 400px; ">
								<table background="http://pzi.ru//f/f7cfddf46173b1be20c3e6f34d08e373.gif" border="0" height="100%" width="100%">
									<tbody>
										<tr>
											<td style="width: 200px; height: 400px; ">
												<table border="0" cellpadding="4" cellspacing="0" height="40%" width="100%">
													<tbody>
														<tr>
															<td align="center" height="5%">
																<a href="/" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image7\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" height="25" name="Image7" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" width="25" /></a></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">НА ГЛАВНУЮ</span></span></span></td>
														</tr>
														<tr>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;"><a href="/history.htm" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image1\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" name="Image1" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" /></a></span></span></span></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">О ЗАВОДЕ</span></span></span></td>
														</tr>
														<tr>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;"><a href="/prod.htm" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image2\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" name="Image2" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" /></a></span></span></span></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">ПРОДУКЦИЯ И УСЛУГИ</span></span></span></td>
														</tr>
														<tr>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;"><a href="/Katchestvo.htm" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image3\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" name="Image3" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" /></a></span></span></span></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">КАЧЕСТВО</span></span></span></td>
														</tr>
														<tr>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;"><a href="/novosty.htm" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image5\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" name="Image5" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" /></a></span></span></span></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">НОВОСТИ</span></span></span></td>
														</tr>
														<tr>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;"><a href="/contact.htm" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image4\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" name="Image4" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" /></a></span></span></span></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">КОНТАКТЫ</span></span></span></td>
														</tr>
														<tr>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;"><a href="/ts/ts.htm" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage(\'Image6\',\'\',\'/f/aaccbbabe9888a6f301a0c3912d0f419.gif\',1)" target="inf"> <img border="0" name="Image6" src="http://pzi.ru//f/db91915d024e840dd8c694b828be2c53.gif" /></a></span></span></span></td>
															<td>
																<span style="color:#ffffff;"><span style="font-size:12px;"><span style="font-family:arial,helvetica,sans-serif;">ТЕПЛО И ГВС&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></td>
														</tr>
														<!--<tr><td align="center">
					<a href="/index_en.htm" target="_top">
					английская версия</a></td></tr>-->
													</tbody>
												</table>
											</td>
										</tr>
									</tbody>
								</table>
							</td>
							<td style="width: 200px; height: 400px; ">
								<div>
									<img alt="Сертификат TUV-CERT" border="0" height="60" src="http://pzi.ru//f/ede28df7e3f1276ee15b26f868d9b1f0.gif" width="85" /></div>
							</td>
						</tr>
						<tr>
							<td align="right" background="http://pzi.ru//f/f7cfddf46173b1be20c3e6f34d08e373.gif" valign="bottom" width="156">
								<img border="0" height="173" src="http://pzi.ru//f/ab461d720bbfe471c6907d65062b792e.gif" width="86" /></td>
							<td align="left" valign="bottom">
								<img border="0" height="173" src="http://pzi.ru//f/2d2e4a4e3cc8aa7827f5355b538e6551.gif" width="87" /></td>
						</tr>
						<tr>
							<td background="http://pzi.ru//f/f7cfddf46173b1be20c3e6f34d08e373.gif" style="text-align: right; vertical-align: bottom; width: 156px; height: 400px; ">
								&nbsp;</td>
							<td align="left" valign="bottom">
								&nbsp;</td>
						</tr>
					</tbody>
				</table>
			</td>
			<td style="text-align: left; vertical-align: top; ">
				<table border="0" cellpadding="0" cellspacing="0" style="width: 100%; ">
					<tbody>
						<tr>
							<td style="width: 10px; height: 40px; ">
								&nbsp;</td>
							<td>
								&nbsp;</td>
							<td style="width: 40px; height: 40px; ">
								&nbsp;</td>
						</tr>
						<tr>
							<td>
								&nbsp;</td>
							<td style="text-align: left; vertical-align: top; ">

';
$after                    = '</td>
                                                        <td>
                                                                &nbsp;</td>
                                                </tr>
                                                <tr>
                                                        <td style="width: 10px; height: 40px; ">
                                                                &nbsp;</td>
                                                        <td>
                                                                <hr align="left" color="#0000a0" valign="top" width="98%" />
                                                                &nbsp;<em><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">ОАО ПЯТИГОРСКИЙ ЗАВОД &laquo;ИМПУЛЬС&raquo;</span></span></em></td>
                                                </tr>
                                        </tbody>
                                </table>
                        </td>
                </tr>
        </tbody>
</table>
';


$SuperUserGroup = GroupQuery::create()->filterByOwnerId(0)->filterByName($configuration['groups']['names']['system']['Superuser']['Name'])->filterByStatus('Active')->filterByDomain($configuration['domain'])->findOne();
if ((isset($SuperUserGroup)) and (AmIInGroup($SuperUserGroup->getId()))) {
  //ok you are in superuser group:
  /*
  Update wiki text request:
  */
  if ((isset($_POST['Text']) and ($_POST['Text'] != ""))) {
    $OldPage = PostQuery::create()->filterByType('Wiki')->filterByRequestUri($_SESSION['REQUEST_URI'])->filterByDomain($configuration['domain'])->orderByVersion('desc')->findOne();
    $OldActivePage = PostQuery::create()->filterByType('Wiki')->filterByRequestUri($_SESSION['REQUEST_URI'])->filterByDomain($configuration['domain'])->filterByStatus('Active')->orderByVersion('desc')->findOne();
    

    if ((isset($_SESSION['AutoGrab'])) and ($_SESSION['AutoGrab'] == '1')) {
      $Purifier = new HTMLPurifier($configuration['HTMLPurifier_Config']);
      $PT       = $Purifier->purify($_POST['Text']);
      $pq       = phpQuery::newDocument($PT);
      
      $html_attr = $configuration['html']['attr'];
      
      foreach (pq('*') as $obj) {
        foreach ($html_attr as $attr) {
          //      pq($obj)->find('head')->remove();
          $src = pq($obj)->attr($attr);
          if ($src != '') {
            $ext = strtolower(implode('.', array_slice(explode('.', $src), - 1)));
            $url = parse_url($src);
            if ((in_array($ext, $configuration['extension']['file']))) {
              if (isset($_SESSION['DomainToGrab'])) {
                $url_to_grab = "http://{$_SESSION['DomainToGrab']}{$s}/{$src}";
                $new_src = GrabFile($url_to_grab);
                pq($obj)->attr($attr, $new_src);
              }
            } elseif ((in_array($ext, $configuration['extension']['image']))) {
              if (isset($_SESSION['DomainToGrab'])) {
                $url_to_grab = "http://{$_SESSION['DomainToGrab']}{$s}/{$src}";
                $new_src = GrabImage($url_to_grab);
                pq($obj)->attr($attr, $new_src);
              }
            }
          }
        }
      }
      $SecureText  = '';
      $SecureText .= $pre;
      $SecureText .= $pq->html();
      $SecureText .= $after;
    } else {
      $SecureText  = '';
      $SecureText .= $pre;
      $Purifier    = new HTMLPurifier($configuration['HTMLPurifier_Config']);
      $SecureText .= $Purifier->purify($_POST['Text']);
      $SecureText .= $after;
    }
    if (($OldPage) and ((hash('md5', $SecureText)) != (hash('md5', $OldPage->getText())))) {

      /*
        Add new page with incremented version:
      */
      $NewPage = new Post();
      $NewPage->setType('Wiki');
      $NewPage->setRequestUri($_SESSION['REQUEST_URI']);
      $NewPage->setText($SecureText);
      $NewPage->setTitle($OldActivePage->getTitle());
      $NewPage->setTags($OldActivePage->getTags());
      $NewPage->setDomain($configuration['domain']);
      $NewPage->setVersion($OldPage->getVersion() + 1);
      $NewPage->setStatus('Active');
      $NewPage->setDate(time());
      $NewPage->Save();
      $User = UserQuery::create()->findPk($_SESSION['UserId']);
      $User->addPost($NewPage);
      $User->Save();
      Jump($_SESSION['REQUEST_URI']);
    } elseif (!$OldPage) {

      /*
        Add new page:
      */
      $NewPage = new Post();
      $NewPage->setType('Wiki');
      $NewPage->setRequestUri($_SESSION['REQUEST_URI']);
      $NewPage->setText($SecureText);
      $NewPage->setDomain($configuration['domain']);
      $NewPage->setVersion('1');
      $NewPage->setStatus('Active');
      $NewPage->setDate(time());
      $NewPage->Save();
      $User = UserQuery::create()->findPk($_SESSION['UserId']);
      $User->addPost($NewPage);
      $User->Save();
      Jump($_SESSION['REQUEST_URI']);
    } else {

      /*
        Do not add page:
      */
      Jump($_SESSION['REQUEST_URI']);

      /*
            $_SESSION['system_message'] = "Not modified: {$_SESSION['REQUEST_URI']}";
            $_SESSION['system_message_navigation'] = "back";
            PrintSystemMessage();
      */
    }
  }
  




  $Page = PostQuery::create()->filterByType('Wiki')->filterByRequestUri($_SESSION['REQUEST_URI'])->filterByDomain($configuration['domain'])->filterByStatus("Active")->orderByVersion('desc')->findOne();
  $smarty->assign('Action', 'WikiEdit');
  if ($Page) {
    $smarty->assign('Title', $Page->getTitle());
    $smarty->assign('Tags', $Page->getTags());
    $smarty->assign('PageText', $Page->getText());
  }
  $smarty->assign('PageName', basename($_SESSION['REQUEST_URI']));
  $smarty->assign('PrePageUri', $_SESSION['REQUEST_URI']);
  $smarty->assign('PrePrePageUri', dirname($_SESSION['REQUEST_URI']));
  $smarty->display("WikiHead.tpl.html");
  $smarty->display("Wiki.tpl.html");
} else {
  //error
  if ((!isset($_SESSION['LoggedIn'])) or ($_SESSION['LoggedIn'] == FALSE)) {
    $_SESSION['edit-login-edit'] = TRUE;
  }
  $smarty->assign('Title', $dic['Error_Ins_Rights_d']);
  $smarty->display('Head.tpl.html');
  $smarty->display('Error_Ins_Rights.tpl.html');
  exit();
}
?>
